#!/bin/bash

"${DIRECTORY}/pkg-install" "openjdk-11-jdk ffmpeg" "$(dirname "$0")" || error "Failed installing openjdk!"

cd $HOME
mkdir -p xdm 
cd xdm
wget -O xdm.tar.xz https://github.com/subhra74/xdm/releases/download/7.2.11/xdm-setup-7.2.11.tar.xz || error "Failed to download XDM setup tar file!"
tar -xf xdm.tar.xz || error "Failed to extract XDM setup tar file!"
sudo ./install.sh | grep -v "Installation completed" || error "Failed to execute XDM setup script!"

# Use system java
sudo sed -i s=/opt/xdman/jre/bin/java=java=g /opt/xdman/xdman || error "Failed to change to system Java runtime!"

# Fix 'Download failed. Failed to append/convert file parts, please check if the drive is full or write protected'
sudo cp $(command -v ffmpeg) /opt/xdman || error "Failed to copy ffmpeg binary! Most likely ffmpeg is not installed. Please run \e[4msudo apt install ffmpeg\e[24m and install XDM again."

# Delete unwanted files after installation
rm -rf $HOME/xdm || error "Failed to remove installation leftovers!"

# Reminder for users to install browser extensiom
echo -e "\nYou may want to install the XDM browser extension. Simply install it from \e[4mXDM Menu -> Tools -> Browser Monitoring\e[0m page."
